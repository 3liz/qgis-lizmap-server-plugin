variables:
  GIT_SUBMODULE_STRATEGY: recursive

stages:
- test
- package
- deploy
- release

qgis-server:
  stage: test
  parallel:
    matrix:
      - QGIS_VERSION: [
        "3.16",
        "3.22",
        "nightly-release",
      ]
  script:
    - make tests FLAVOR=${QGIS_VERSION}
  environment:
    name: snap
  tags:
    - infrav3

package:
  stage: package
  before_script:
    - TAG=$(git describe --tags $(git rev-list --tags --max-count=1))
    - VERSION=$(echo ${TAG} | awk -F. -v OFS=. 'NF==1{print ++$NF}; NF>1{if(length($NF+1)>length($NF))$(NF-1)++; $NF=sprintf("%0*d", length($NF), ($NF+1)%(10^length($NF))); print}')-alpha
  image: registry.snap.lizlan:5000/factory/qgis-plugin-ci:latest
  environment: snap
  script:
    - qgis-plugin-ci package ${VERSION}
  after_script:
    # Need to copy/paste these two lines because variables are lost
    - TAG=$(git describe --tags $(git rev-list --tags --max-count=1))
    - VERSION=$(echo ${TAG} | awk -F. -v OFS=. 'NF==1{print ++$NF}; NF>1{if(length($NF+1)>length($NF))$(NF-1)++; $NF=sprintf("%0*d", length($NF), ($NF+1)%(10^length($NF))); print}')-alpha
  tags:
    - infrav3-plain
  artifacts:
    expose_as: 'QGIS package'
    paths:
      - lizmap_server.${CI_COMMIT_REF_NAME}.zip

deploy:
  stage: deploy
  script:
    - upload_to_packages_server lizmap_server.${CI_COMMIT_REF_NAME}.zip pub/lizmap-server-qgis-plugin/${CI_COMMIT_REF_NAME}
  tags:
    - fabric

tickets:
  stage: release
  only:
    - tags
  image:
    name: registry.snap.lizlan:5000/infra/ci-tools:latest
  script:
    - create_ticket.py
  tags:
    - factory-plain
